<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>JMeter3.0图形化HTML报告中文乱码问题处理 | Luo&#39;s Blog</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="性能测试,JMeter," />
  

  <meta name="description" content="JMeter，图形化，HTML报告，中文乱码">
<meta property="og:type" content="article">
<meta property="og:title" content="JMeter3.0图形化HTML报告中文乱码问题处理">
<meta property="og:url" content="http://www.aloo.me/2016/08/19/JMeter3-0图形化HTML报告中文乱码问题处理/index.html">
<meta property="og:site_name" content="Luo's Blog">
<meta property="og:description" content="JMeter，图形化，HTML报告，中文乱码">
<meta property="og:image" content="http://ww2.sinaimg.cn/bmiddle/9bd9d3e2gw1f6z4u2pk8ij20gy0c379r.jpg">
<meta property="og:image" content="http://ww2.sinaimg.cn/large/9bd9d3e2gw1f6yz2cx85gj20c104vaav.jpg">
<meta property="og:image" content="http://ww3.sinaimg.cn/large/9bd9d3e2gw1f6yyuwwisfj20jk083gnb.jpg">
<meta property="og:image" content="http://ww3.sinaimg.cn/large/9bd9d3e2gw1f6yyuwy12uj20ib06xt9g.jpg">
<meta property="og:image" content="http://ww3.sinaimg.cn/large/9bd9d3e2gw1f6yyuxt0g0j20ie06f0te.jpg">
<meta property="og:updated_time" content="2016-08-19T08:35:33.936Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JMeter3.0图形化HTML报告中文乱码问题处理">
<meta name="twitter:description" content="JMeter，图形化，HTML报告，中文乱码">
<meta name="twitter:image" content="http://ww2.sinaimg.cn/bmiddle/9bd9d3e2gw1f6z4u2pk8ij20gy0c379r.jpg">

  

  
    <link rel="icon" href="http://ww3.sinaimg.cn/large/9bd9d3e2gw1f5scw4o8tnj206t06sdgf.jpg">
  

  <link href="/css/styles.css?v=028c63b1" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-79979510-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?da576f05e763e7049e80f64294de0bde";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  <link href="http://cdn.staticfile.org/highlight.js/9.0.0/styles/solarized-light.min.css" rel="stylesheet">  
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">导航</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">导航</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-问题概述"><span class="toc-text">一. 问题概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-解决方案"><span class="toc-text">二. 解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础方案"><span class="toc-text">基础方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#推荐方案"><span class="toc-text">推荐方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件分享"><span class="toc-text">文件分享</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-成因分析"><span class="toc-text">三. 成因分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四-总结"><span class="toc-text">四. 总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-text">References</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-JMeter3-0图形化HTML报告中文乱码问题处理" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">JMeter3.0图形化HTML报告中文乱码问题处理</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2016.08.19</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Luo</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/技能锻造室/">技能锻造室</a>
  </span>



      

    </div>
  </header>

  <div class="article-content">
    
      <div align="center"><img src="http://ww2.sinaimg.cn/bmiddle/9bd9d3e2gw1f6z4u2pk8ij20gy0c379r.jpg" alt="Image: discovermagazine.com/"></div>

<blockquote>
<p>之前在博客中介绍了JMeter 3.0版本新特性：<a href="http://www.aloo.me/2016/07/17/JMeter%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%953-0%E6%97%B6%E4%BB%A3%E4%B9%8B-%E5%A4%9A%E7%BB%B4%E5%BA%A6%E7%9A%84%E5%9B%BE%E5%BD%A2%E5%8C%96HTML%E6%8A%A5%E5%91%8A/">Dashboard Report</a>，用于为JMeter测试结果生成多维度的图形化HTML报告，包括聚合报告、吞吐量趋势图、平均响应时间趋势图等十多种图表，为我们性能测试的结果分析和报告输出提供了很多便利。<br>本文主要介绍如何解决JMeter脚本中取样器(Sampler)名称定义为中文时，生成的HTML报告中中文展示为乱码的问题。</p>
</blockquote>
<h2 id="一-问题概述"><a href="#一-问题概述" class="headerlink" title="一. 问题概述"></a>一. 问题概述</h2><p>由于个人在JMeter 3.0的实际应用中，脚本中的Test Plan/Sampler等元件命名都没有使用中文，所以在之前介绍Dashboard Report特性的博客(原文戳<a href="(http://www.aloo.me/2016/07/17/JMeter%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%953-0%E6%97%B6%E4%BB%A3%E4%B9%8B-%E5%A4%9A%E7%BB%B4%E5%BA%A6%E7%9A%84%E5%9B%BE%E5%BD%A2%E5%8C%96HTML%E6%8A%A5%E5%91%8A/">这里</a>))成文时，没有提到关于中文的问题。之后有朋友反馈，Sampler名称为中文时，生成的报告中展示为乱码，自己测试，确实如此。<br>如图，脚本包含两个命名为中文的Sampler：<br><img src="http://ww2.sinaimg.cn/large/9bd9d3e2gw1f6yz2cx85gj20c104vaav.jpg" alt=""><br>执行测试后，生成的Dashboard Report图表中文乱码：<br><img src="http://ww3.sinaimg.cn/large/9bd9d3e2gw1f6yyuwwisfj20jk083gnb.jpg" alt=""><br><img src="http://ww3.sinaimg.cn/large/9bd9d3e2gw1f6yyuwy12uj20ib06xt9g.jpg" alt=""><br>于是通过查看官方文档和源码，找到原因并进行了解决，原打算直接追加到之前那篇文章，但考虑到篇幅过长，于是决定新成一文，然后在之前的文章中补充链接。</p>
<h2 id="二-解决方案"><a href="#二-解决方案" class="headerlink" title="二. 解决方案"></a>二. 解决方案</h2><p>先上解决方案：修改JMeter report模块读取数据源码中的字符集设置为UTF-8，编译后替换到<code>JMETER_HOME\lib\ext\ApacheJMeter_core.jar</code>内，这里会分享一个我处理好的一个jar包，但建议自己亲自动手：</p>
<h3 id="基础方案"><a href="#基础方案" class="headerlink" title="基础方案"></a>基础方案</h3><ol>
<li>在官网<a href="http://jmeter.apache.org/download_jmeter.cgi" target="_blank" rel="external">下载页面</a>下载<code>apache-jmeter-3.0_src.zip</code></li>
<li>相关源码位置：<br><code>apache-jmeter-3.0/src/core/org/apache/jmeter/report/core/CsvSampleReader.java</code></li>
<li>将<code>CsvSampleReader</code>的<code>CHARST</code>赋值为<code>UTF-8</code><pre><code class="java">private static final String CHARSET = StandardCharsets.UTF_8.displayName();
</code></pre>
</li>
<li>编译该文件，用得到的<code>.class</code>文件替换<code>JMETER_HOME\lib\ext\ApacheJMeter_core.jar</code>内的原文件。当然也可以直接对源码重新编译打包，但会比较费时。</li>
</ol>
<p>效果如图：<br><img src="http://ww3.sinaimg.cn/large/9bd9d3e2gw1f6yyuxt0g0j20ie06f0te.jpg" alt=""></p>
<h3 id="推荐方案"><a href="#推荐方案" class="headerlink" title="推荐方案"></a>推荐方案</h3><p>关于设置字符编码，一个更推荐的方案是设置默认字符编码为UTF-8，同时支持.properties配置项。JMeter读写结果文件(xml/csv)的字符编码配置项是<code>./bin/saveservice.properties</code>文件内的<code>_file_encoding</code>，由<code>org.apache.jmeter.save.SaveService.getFileEncoding(String dflt)</code>读取，当没有在配置相中指定时，将使用方法的入参作为默认编码，这里我们传入UFT-8作为默认格式，因此将基础方案中的步骤3做如下变更：</p>
<pre><code class="java">private static final String CHARSET = SaveService.getFileEncoding(StandardCharsets.UTF_8.displayName());
</code></pre>
<p>编译后替换即可。saveservice.properties文件的_file_encoding默认已配置为UTF-8，多数情况下，我们不需要修改。</p>
<h3 id="文件分享"><a href="#文件分享" class="headerlink" title="文件分享"></a>文件分享</h3><p>分享的文件和jar包是使用推荐方案进行处理。可以去用class文件自己替换进本地的ApacheJMeter_core.jar，也可以直接下载分享的jar包替换本地jar包。</p>
<ul>
<li>编译好的.class文件：<code>https://pan.baidu.com/s/1bo10QnX</code>，提取码<code>ee68</code></li>
<li>处理完成的ApacheJMeter_core.jar： <code>https://pan.baidu.com/s/1mhKLwgw</code>，提取码<code>id7h</code></li>
</ul>
<p><em>注：github上可以看到jmeter的trunk分支已经将dashboard report的默认字符编码更改为UFT-8，本文的推荐方案即是官方更新中的实现方式。只是目前官方还没有发布更新，所以自己动手。</em></p>
<h2 id="三-成因分析"><a href="#三-成因分析" class="headerlink" title="三. 成因分析"></a>三. 成因分析</h2><p>Dashboard Report特性生成HTML图表，使用JMeter记录测试结果数据的文件<em>(命令行执行时<code>-l</code>指定的文件，也可在图形界面的监听器中指定，作为基础知识不在这里展开)</em>作为数据源，Apache FreeMarker作为模板引擎，默认的模板位于JMETER_HOME\bin\report-template。</p>
<ul>
<li>查看官方说明，确认没有关于HTML报告字符编码的配置项。</li>
<li>查看数据源文件，确定文件格式为UTF-8，文件中的中文正常可读，排除数据源存在问题的可能。</li>
<li>查看生成的结果文件，主要数据在<code>指定路径/content/js/graph.js</code>，任选一个图表数据，查看其标签的值(“label”:”<em>*</em>“)，显示为乱码，排除js解析成乱码的可能。</li>
<li>此时首先想到Java文件读取过程问题，从官方发布的源码包查看源码<code>src/core/org/apache/jmeter/report/core/CsvSampleReader</code>，发现代码中字符编码指定为ISO8859-1:<pre><code class="java">package org.apache.jmeter.report.core;
//次要内容略...
public class CsvSampleReader implements Closeable{
  //次要内容略...
  private static final String CHARSET = &quot;ISO8859-1&quot;;
  //次要内容略...
  private CsvSampleReader(File inputFile, SampleMetadata metadata, char separator, boolean useSaveSampleCfg) {
    if (!(inputFile.isFile() &amp;&amp; inputFile.canRead())) {
      throw new IllegalArgumentException(inputFile.getAbsolutePath()
              + &quot; does not exist or is not readable&quot;);
    }
    this.file = inputFile;
    try {
      this.reader = new BufferedReader(new InputStreamReader(
              new FileInputStream(file), CHARSET), BUF_SIZE);
    } catch (FileNotFoundException | UnsupportedEncodingException ex) {
      throw new SampleException(&quot;Could not create file reader !&quot;, ex);
    }
  }
}
</code></pre>
至此，问题原因得以确定。</li>
</ul>
<h2 id="四-总结"><a href="#四-总结" class="headerlink" title="四. 总结"></a>四. 总结</h2><p>本文主要介绍使用JMeter 3.0新特性生成HTML图形化报告时，中文标签展示为乱码的现象，成因以及简单解决方案。另外，github上JMeter的trunk分支已经有相应更新，预计在下一次版本发布中，该问题应该可以得到修复。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a href="http://jmeter.apache.org/devguide-dashboard.html" target="_blank" rel="external">devguide-dashboard</a></li>
<li><a href="https://github.com/apache/jmeter" target="_blank" rel="external">github－apache/jmeter</a></li>
</ol>

    
  </div>
</article>

</div>





  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    
  <section class="duoshuo-comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="" data-title="JMeter3.0图形化HTML报告中文乱码问题处理" data-url="http://www.aloo.me/2016/08/19/JMeter3-0图形化HTML报告中文乱码问题处理/index.html"></div>
    <!-- 多说评论框 end -->
  </section>




  <script type="text/javascript">
  var duoshuoQuery = {short_name:"aloo"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>


  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

  <script src="http://cdn.staticfile.org/highlight.js/9.0.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
